type: Test
spec:
  id: e2e-custom-headers-upstream
  name: e2e-custom-headers-upstream
  description: Test custom trace header propagation to upstream services
  trigger:
    type: http
    httpRequest:
      url: custom-headers:8080/upstream
      method: GET
      headers:
        - key: X-Correlation-ID
          value: def45600000000000000000000000000-def4560000000000-01

  specs:
    - name: Check main span exists with correct trace ID
      selector: span[tracetest.span.type="http" name="GET /upstream"]
      assertions:
        - attr:http.method  =  "GET"
        - attr:http.status_code  =  200
        - attr:tracetest.span.name = "GET /upstream"
        # Verify the trace ID matches what was in X-Correlation-ID header
        - attr:trace_id = "def45600000000000000000000000000"
    
    - name: Check upstream call span exists
      selector: span[tracetest.span.type="http" name="GET http://localhost:8080/test"]
      assertions:
        - attr:http.method  =  "GET"
        - attr:http.status_code  =  200
        # Verify trace continuity - same trace ID propagated to upstream
        - attr:trace_id = "def45600000000000000000000000000"
    
    - name: Verify span hierarchy
      selector: span[tracetest.span.type="http" name="GET /upstream"]
      assertions:
        # Should have at least one child span (the upstream call)
        - attr:tracetest.selected_spans.count >= 1
